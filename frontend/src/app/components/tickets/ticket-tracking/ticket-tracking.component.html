<div class="ticket-tracking-container">
  <!-- Barra de búsqueda -->
  <div class="search-container">
    <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="search-form">
      <div class="search-input-group">
        <input
          type="text"
          formControlName="ticketId"
          placeholder="BUSCAR POR ID"
          class="search-input"
        >
        <button type="submit" class="search-button">
          <i class="fas fa-search"></i>
        </button>
        <button type="button" class="clear-button" (click)="clearSearch()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </form>
  </div>

  <!-- Leyenda de estados -->
  <div class="status-legend">
    <div class="legend-item">
      <div class="status-dot" style="background-color: red;"></div>
      <span>PENDIENTE</span>
    </div>
    <div class="legend-item">
      <div class="status-dot" style="background-color: yellow;"></div>
      <span>EN PROGRESO</span>
    </div>
    <div class="legend-item">
      <div class="status-dot" style="background-color: lightgreen;"></div>
      <span>ESCALADO</span>
    </div>
    <div class="legend-item">
      <div class="status-dot" style="background-color: darkgreen;"></div>
      <span>FINALIZADO</span>
    </div>
    <div class="legend-item">
      <div class="status-dot" style="background-color: blue;"></div>
      <span>CERRADO</span>
    </div>
  </div>

  <!-- Tabla de tickets -->
  <div class="tickets-table-container">
    <table class="tickets-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ESTADO</th>
          <th>PRIORIDAD</th>
          <th>FECHA CREACION</th>
          <th>TECNICO ASIGNADO</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of filteredTickets" class="ticket-row" (click)="verDetalles(ticket)">
          <td class="ticket-id">{{ ticket.id }}</td>
          <td class="ticket-status">
            <div class="status-indicator" [style.background-color]="getEstadoColor(ticket.estado)"></div>
            <span class="status-text">{{ getEstadoLabel(ticket.estado) }}</span>
          </td>
          <td class="ticket-priority">
            <span class="priority-badge" [class]="getPrioridadClass(ticket.prioridad)">
              {{ getPrioridadText(ticket.prioridad) }}
            </span>
          </td>
          <td class="ticket-date">{{ ticket.fechaCreacion | date:'dd-MM-yyyy' }}</td>
          <td class="ticket-technician">{{ getTecnicoAsignado(ticket) }}</td>
        </tr>
        <tr *ngIf="filteredTickets.length === 0 && !isLoading">
          <td colspan="5" class="no-tickets">No se encontraron tickets</td>
        </tr>
        <tr *ngIf="isLoading">
          <td colspan="5" class="loading">Cargando tickets...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Controles de paginación -->
  <div class="pagination-container" *ngIf="totalPages > 1 || totalItems > 0">
    <div class="pagination-controls">
      <div class="pagination-info">
        <span>Mostrando {{ getDisplayedRange() }} de {{ totalItems }} tickets</span>
      </div>
      <div class="pagination-buttons">
        <button
          class="pagination-btn"
          [disabled]="!hasPrevPage || isLoading"
          (click)="goToPage(currentPage - 1)">
          ← Anterior
        </button>
        <div class="page-numbers">
          <button
            *ngFor="let page of getPaginationArray()"
            class="page-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        </div>
        <button
          class="pagination-btn"
          [disabled]="!hasNextPage || isLoading"
          (click)="goToPage(currentPage + 1)">
          Siguiente →
        </button>
      </div>
      <div class="pagination-page-info" *ngIf="totalPages > 1">
        <span>Página {{ currentPage }} de {{ totalPages }}</span>
      </div>
      <div class="items-per-page">
        <label>Mostrar:</label>
        <select [value]="itemsPerPage" (change)="onItemsPerPageChange($event)">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Panel de detalles del ticket -->
  <div class="modal-overlay" *ngIf="showTicketDetails && selectedTicket" (click)="cerrarDetalles()">
    <div class="ticket-details-panel" (click)="$event.stopPropagation()">
    <div class="details-header">
      <h2>Detalles del Ticket</h2>
      <button class="close-button" (click)="cerrarDetalles()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Notificación de cambio automático -->
    <div class="auto-change-notification" *ngIf="showAutoChangeNotification">
      <i class="fas fa-info-circle"></i>
      <span>Estado cambiado automáticamente a "En Progreso"</span>
    </div>

    <div class="ticket-details-content">
      <div class="detail-row">
        <div class="detail-item">
          <label>ID del Ticket:</label>
          <span class="detail-value">{{ selectedTicket.id }}</span>
        </div>
        <div class="detail-item">
          <label>Estado:</label>
          <span class="detail-value">
            <div class="status-indicator" [style.background-color]="getEstadoColor(selectedTicket.estado)"></div>
            {{ getEstadoLabel(selectedTicket.estado) }}
          </span>
        </div>
      </div>


      <div class="detail-row">
        <div class="detail-item">
          <label>Prioridad:</label>
          <span class="detail-value">
            <span class="priority-badge" [class]="getPrioridadClass(selectedTicket.prioridad)">
              {{ getPrioridadText(selectedTicket.prioridad) }}
            </span>
          </span>
        </div>
      </div>

      <div class="detail-item">
        <label>Categoría:</label>
        <span class="detail-value">{{ selectedTicket.categoria }} - {{ selectedTicket.subcategoria }}</span>
      </div>

      <div class="detail-item">
        <label>Descripción:</label>
        <p class="ticket-description">{{ selectedTicket.descripcion }}</p>
      </div>

      <div class="pending-details" *ngIf="selectedTicket.pendienteMotivo">
        <h3 class="pending-title">El técnico ha marcado este ticket como pendiente</h3>
        <p class="pending-motive">{{ selectedTicket.pendienteMotivo }}</p>
        <div class="pending-meta">
          <span *ngIf="selectedTicket.pendienteTiempoEstimado">
            <strong>Tiempo estimado para retomar:</strong>
            {{ selectedTicket.pendienteTiempoEstimado }}
          </span>
          <span *ngIf="selectedTicket.pendienteActualizadoEn">
            <strong>Última actualización:</strong>
            {{ selectedTicket.pendienteActualizadoEn | date:'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
      </div>

      <div class="reopen-details" *ngIf="selectedTicket.reapertura">
        <h3 class="reopen-title">Ticket reabierto por el usuario</h3>
        <p class="reopen-observaciones">{{ selectedTicket.reapertura.observacionesUsuario }}</p>
        <div class="reopen-meta">
          <span *ngIf="selectedTicket.reapertura.fechaReapertura">
            <strong>Fecha de reapertura:</strong>
            {{ selectedTicket.reapertura.fechaReapertura | date:'dd/MM/yyyy HH:mm' }}
          </span>
          <span *ngIf="selectedTicket.reapertura.fechaRespuestaTecnico">
            <strong>Respuesta del técnico:</strong>
            {{ selectedTicket.reapertura.fechaRespuestaTecnico | date:'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
        <div class="reopen-causa" *ngIf="selectedTicket.reapertura.causaTecnico">
          <strong>Causa indicada:</strong>
          <p>{{ selectedTicket.reapertura.causaTecnico }}</p>
        </div>
      </div>


      <div class="detail-item">
        <label>Tiempo estimado de solución:</label>
        <span class="detail-value">{{ selectedTicket.tiempoEstimado }}</span>
      </div>

      <div class="detail-item">
        <label>Fecha de creación:</label>
        <span class="detail-value">{{ selectedTicket.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
      </div>

      <div class="detail-item">
        <label>Técnico asignado:</label>
        <span class="detail-value">{{ getTecnicoAsignado(selectedTicket) }}</span>
      </div>
    </div>
    </div>
  </div>
</div>
