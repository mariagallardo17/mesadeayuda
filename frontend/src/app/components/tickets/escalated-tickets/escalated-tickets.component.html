<div class="escalated-tickets-container">
  <!-- Header -->
  <div class="tickets-header">
    <h1>Tickets Escalados</h1>
  </div>

  <!-- Filtros y b√∫squeda -->
  <div class="filters-container">
    <div class="search-box">
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por ID, categor√≠a, descripci√≥n, prioridad o estado..."
        [(ngModel)]="searchText"
        (input)="onSearchChange()"
      >
      <span class="search-icon">üîç</span>
    </div>
    <div class="filter-box">
      <label for="estado-filter">Filtrar por estado:</label>
      <select
        id="estado-filter"
        class="estado-filter"
        [(ngModel)]="selectedEstado"
        (change)="onEstadoChange()"
      >
        <option value="todos">Todos los estados</option>
        <option *ngFor="let estado of estados" [value]="estado.value">
          {{ estado.label }}
        </option>
      </select>
    </div>
    <button
      *ngIf="searchText || selectedEstado !== 'todos'"
      class="clear-filters-btn"
      (click)="clearFilters()"
    >
      Limpiar filtros
    </button>
  </div>

  <!-- Tabla de tickets -->
  <div class="tickets-table-container">
    <table class="tickets-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>FECHA</th>
          <th>INFORMACION</th>
          <th>STATUS</th>
          <th>PRIORIDAD</th>
          <th *ngIf="canViewTechnicalInfo">TIEMPO RESTANTE</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of filteredTickets" class="ticket-row">
          <td class="ticket-id">{{ ticket.id }}</td>
          <td class="ticket-date">{{ formatDate(ticket.fecha_creacion) }}</td>
          <td class="ticket-info">
            <button class="ver-detalles-btn" (click)="verDetalles(ticket)">
              VER DETALLES
            </button>
          </td>
          <td class="ticket-status">
            <div class="status-indicator" [style.background-color]="getEstadoColor(ticket.estatus)"></div>
            <span class="status-text">{{ getEstadoLabel(ticket.estatus) }}</span>
          </td>
          <td class="ticket-priority">
            <div class="priority-badge" [ngClass]="getPriorityClass(ticket)">
              <span class="priority-text">{{ ticket.prioridad }}</span>
              <span *ngIf="isUrgent(ticket)" class="urgent-indicator">‚ö†Ô∏è URGENTE</span>
            </div>
          </td>
          <td *ngIf="canViewTechnicalInfo" class="ticket-countdown">
            <app-countdown
              *ngIf="ticket.estatus !== 'Cerrado' && ticket.estatus !== 'Finalizado' && ticket.tiempo_objetivo"
              [ticketId]="ticket.id"
              [creationDate]="parseDateForCountdown(ticket)"
              [targetTime]="ticket.tiempo_objetivo.toString()"
              [ticketStatus]="ticket.estatus"
              [showLabel]="false"
              size="small">
            </app-countdown>
            <app-countdown
              *ngIf="(ticket.estatus === 'Finalizado' || ticket.estatus === 'Cerrado') && ticket.tiempo_objetivo"
              [ticketId]="ticket.id"
              [creationDate]="parseDateForCountdown(ticket)"
              [targetTime]="ticket.tiempo_objetivo.toString()"
              [ticketStatus]="ticket.estatus"
              [tiempoAtencionSegundos]="ticket.tiempo_atencion_segundos"
              [showLabel]="false"
              size="small">
            </app-countdown>
            <span *ngIf="ticket.estatus !== 'Cerrado' && ticket.estatus !== 'Finalizado' && !ticket.tiempo_objetivo" class="no-time">Sin tiempo</span>
          </td>
        </tr>
        <tr *ngIf="filteredTickets.length === 0 && !isLoading && tickets.length > 0">
          <td [attr.colspan]="canViewTechnicalInfo ? 6 : 5" class="no-tickets">
            No se encontraron tickets con los filtros aplicados
          </td>
        </tr>
        <tr *ngIf="tickets.length === 0 && !isLoading">
          <td [attr.colspan]="canViewTechnicalInfo ? 6 : 5" class="no-tickets">No hay tickets escalados</td>
        </tr>
        <tr *ngIf="isLoading">
          <td [attr.colspan]="canViewTechnicalInfo ? 6 : 5" class="loading">Cargando tickets...</td>
        </tr>
      </tbody>
    </table>

    <!-- Controles de paginaci√≥n -->
    <div class="pagination-container" *ngIf="totalPages > 1 || totalItems > 0">
      <div class="pagination-info">
        <span>Mostrando {{ startItem }}-{{ endItem }} de {{ totalItems }} tickets</span>
        <select [(ngModel)]="itemsPerPage" (change)="changeItemsPerPage(itemsPerPage)" class="items-per-page">
          <option [value]="10">10 por p√°gina</option>
          <option [value]="20">20 por p√°gina</option>
          <option [value]="50">50 por p√°gina</option>
        </select>
      </div>
      <div class="pagination-controls" *ngIf="totalPages > 1">
        <button
          class="pagination-btn"
          [disabled]="!hasPrevPage || isLoading"
          (click)="goToPage(currentPage - 1)">
          ‚Üê Anterior
        </button>
        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="page-number"
            [class.active]="page === currentPage"
            [disabled]="isLoading"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        </div>
        <button
          class="pagination-btn"
          [disabled]="!hasNextPage || isLoading"
          (click)="goToPage(currentPage + 1)">
          Siguiente ‚Üí
        </button>
      </div>
      <div class="pagination-page-info" *ngIf="totalPages > 1">
        <span>P√°gina {{ currentPage }} de {{ totalPages }}</span>
      </div>
    </div>
  </div>

  <!-- Modal de detalles del ticket -->
  <div class="modal-overlay" *ngIf="showDetailsModal && selectedTicket" (click)="cerrarDetalles()">
    <div class="modal-content ticket-details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Informaci√≥n del ticket #{{ selectedTicket.id }}</h2>
        <button class="close-btn" (click)="cerrarDetalles()">√ó</button>
      </div>

      <div class="ticket-details-content">
        <div class="detail-item">
          <label>Fecha de creaci√≥n:</label>
          <span>{{ formatDate(selectedTicket.fecha_creacion) }}</span>
        </div>

        <div class="detail-item">
          <label>Datos del usuario:</label>
          <span>{{ selectedTicket.usuario?.nombre || 'N/A' }} ({{ selectedTicket.usuario?.correo || 'Sin correo' }})</span>
        </div>

        <div class="detail-item">
          <label>Categor√≠a:</label>
          <span>{{ selectedTicket.categoria || 'N/A' }} - {{ selectedTicket.subcategoria || 'N/A' }}</span>
        </div>

        <div class="detail-item">
          <label>Descripci√≥n del ticket:</label>
          <p class="ticket-description">{{ selectedTicket.descripcion || 'Sin descripci√≥n' }}</p>
        </div>

        <div class="detail-item" *ngIf="canViewTechnicalInfo && selectedTicket.tiempo_objetivo">
          <label>Tiempo aproximado de soluci√≥n:</label>
          <span>{{ selectedTicket.tiempo_objetivo }}</span>
        </div>

        <div class="detail-item">
          <label>Escalamiento:</label>
          <div class="escalation-info">
            <p><strong>T√©cnico asignado:</strong>
              <span *ngIf="selectedTicket.tecnico; else sinTecnico">
                {{ selectedTicket.tecnico.nombre }} ({{ selectedTicket.tecnico.correo }})
              </span>
              <ng-template #sinTecnico>
                <span>Sin asignar</span>
              </ng-template>
            </p>
            <p><strong>Fecha de escalamiento:</strong> {{ selectedTicket.escalamiento && selectedTicket.escalamiento.fecha ? formatDateTime(selectedTicket.escalamiento.fecha) : 'N/A' }}</p>
            <p><strong>Motivo:</strong></p>
            <p class="motivo-detalle">{{ selectedTicket.escalamiento && selectedTicket.escalamiento.motivo ? selectedTicket.escalamiento.motivo : 'Sin motivo especificado' }}</p>
          </div>
        </div>

        <!-- Panel de cambio de estado - Solo para t√©cnicos y administradores, NO para tickets cerrados -->
        <div class="status-changer" *ngIf="puedeCambiarEstados && selectedTicket.estatus !== 'Cerrado'">
          <h3>Da click para cambiar estado del ticket</h3>
          <div class="status-options">
            <div
              *ngFor="let estado of estadosDisponibles"
              class="status-option"
              [class.selected]="selectedTicket.estatus === estado.value"
              (click)="cambiarEstado(selectedTicket, estado.value)"
              [style.background-color]="estado.color"
            >
              <div class="status-circle" [style.background-color]="estado.color"></div>
              <span class="status-label">{{ estado.label }}</span>
            </div>
          </div>
        </div>

        <!-- Mensaje para tickets cerrados -->
        <div class="ticket-closed-message" *ngIf="selectedTicket.estatus === 'Cerrado'">
          <div class="closed-info">
            <div class="closed-icon">üîí</div>
            <div class="closed-content">
              <h3>Ticket Cerrado</h3>
              <p>Este ticket ha sido cerrado y no puede ser modificado.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal-overlay confirm-modal-overlay" *ngIf="showConfirmModal" (click)="cerrarModalConfirmacion()">
    <div class="modal-content confirm-modal-content" (click)="$event.stopPropagation()">
      <div class="confirm-modal-header">
        <h2>{{ confirmTitle }}</h2>
        <button class="close-btn" (click)="cerrarModalConfirmacion()">√ó</button>
      </div>
      <div class="confirm-modal-body">
        <p>{{ confirmMessage }}</p>

        <!-- Campo de comentario solo cuando se regresa a En Progreso -->
        <div *ngIf="estadoParaConfirmar === 'En Progreso'" class="comentario-tecnico-field">
          <label for="comentarioTecnico">Comentario para el t√©cnico (opcional):</label>
          <textarea
            id="comentarioTecnico"
            [(ngModel)]="comentarioTecnico"
            placeholder="Escribe un comentario privado para el t√©cnico. Este comentario solo ser√° visible para el t√©cnico, no para el usuario."
            rows="4"
            class="comentario-textarea"
          ></textarea>
          <p class="field-hint">üí° Este comentario solo ser√° visible para el t√©cnico asignado</p>
        </div>
      </div>
      <div class="confirm-modal-actions">
        <button class="cancel-btn" (click)="cerrarModalConfirmacion()">Cancelar</button>
        <button class="confirm-btn" (click)="confirmarCambioEstado()" [disabled]="isLoading">
          <span *ngIf="!isLoading">Aceptar</span>
          <span *ngIf="isLoading">Procesando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de √©xito -->
  <div class="modal-overlay success-modal-overlay" *ngIf="showSuccessModal" (click)="cerrarSuccessModal()">
    <div class="modal-content success-modal-content" (click)="$event.stopPropagation()">
      <div class="success-modal-header">
        <div class="success-icon">‚úì</div>
        <h2>¬°√âxito!</h2>
      </div>
      <div class="success-modal-body">
        <p>{{ successMessage }}</p>
      </div>
      <div class="success-modal-actions">
        <button class="success-ok-btn" (click)="cerrarSuccessModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal de error -->
  <div class="modal-overlay error-modal-overlay" *ngIf="showErrorModal" (click)="cerrarErrorModal()">
    <div class="modal-content error-modal-content" (click)="$event.stopPropagation()">
      <div class="error-modal-header">
        <div class="error-icon">‚úó</div>
        <h2>Error</h2>
      </div>
      <div class="error-modal-body">
        <p>{{ errorMessage }}</p>
      </div>
      <div class="error-modal-actions">
        <button class="error-ok-btn" (click)="cerrarErrorModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal para marcar ticket como pendiente -->
  <div class="modal-overlay" *ngIf="showPendienteModal" (click)="cerrarModalPendiente()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border-radius: 12px 12px 0 0;">
        <h2 style="color: white; margin: 0; font-size: 1.5rem; font-weight: 600;">Marcar ticket como pendiente</h2>
        <button class="close-btn" (click)="cerrarModalPendiente()" style="color: white; background: rgba(255, 255, 255, 0.2);">√ó</button>
      </div>

      <div class="modal-body" style="padding: 20px;">
      <form [formGroup]="pendingForm" (ngSubmit)="guardarPendiente()">
        <div class="form-group">
          <label for="motivoPendiente">Describe el motivo</label>
          <textarea
            id="motivoPendiente"
            formControlName="motivo"
            class="form-control"
            rows="4"
            placeholder="Ejemplo: Esperando confirmaci√≥n del proveedor"
          ></textarea>
          <div class="error-message" *ngIf="pendingForm.get('motivo')?.invalid && pendingForm.get('motivo')?.touched">
            *Este campo es obligatorio (m√°ximo 500 caracteres)
          </div>
        </div>

        <div class="form-group">
          <label for="tiempoPendiente">Tiempo estimado para retomar</label>
          <input
            id="tiempoPendiente"
            type="text"
            class="form-control"
            formControlName="tiempoEstimado"
            placeholder="Ejemplo: 4 horas"
          />
          <div class="error-message" *ngIf="pendingForm.get('tiempoEstimado')?.invalid && pendingForm.get('tiempoEstimado')?.touched">
            *Indica el tiempo estimado (m√°ximo 100 caracteres)
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="cerrarModalPendiente()" [disabled]="isLoading">
            Cancelar
          </button>
          <button type="submit" class="submit-btn" [disabled]="pendingForm.invalid || isLoading">
            <span *ngIf="!isLoading">Guardar como pendiente</span>
            <span *ngIf="isLoading">Guardando...</span>
          </button>
        </div>
      </form>
      </div>
    </div>
  </div>

  <!-- Modal de escalamiento -->
  <div class="modal-overlay" *ngIf="showEscalateModal" (click)="cerrarEscalamiento()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border-radius: 12px 12px 0 0;">
        <h2 style="color: white; margin: 0; font-size: 1.5rem; font-weight: 600;">Escalar ticket</h2>
        <button class="close-btn" (click)="cerrarEscalamiento()" style="color: white; background: rgba(255, 255, 255, 0.2);">√ó</button>
      </div>

      <div class="modal-body" style="padding: 20px;">
      <form [formGroup]="escalateForm" (ngSubmit)="escalarTicket()">

        <div class="form-group">
          <label for="tecnicoDestino">Seleccionar t√©cnico destino</label>
          <select
            id="tecnicoDestino"
            formControlName="tecnicoDestino"
            class="form-control"
            [disabled]="isLoadingTechnicians">
            <option value="">Selecciona un t√©cnico...</option>
            <option *ngFor="let tech of technicians" [value]="tech.id">
              {{ tech.nombre }} ({{ tech.correo }})
            </option>
          </select>
          <div *ngIf="isLoadingTechnicians" class="loading-technicians">
            Cargando t√©cnicos...
          </div>
          <div *ngIf="escalateForm.get('tecnicoDestino')?.invalid && escalateForm.get('tecnicoDestino')?.touched" class="error-message">
            *Debes seleccionar un t√©cnico
          </div>
        </div>

        <div class="form-group">
          <label for="motivoEscalamiento">Motivo de escalamiento</label>
          <textarea
            id="motivoEscalamiento"
            formControlName="motivoEscalamiento"
            class="form-control"
            rows="4"
            placeholder="Describe el motivo del escalamiento...">
          </textarea>
          <div *ngIf="escalateForm.get('motivoEscalamiento')?.invalid && escalateForm.get('motivoEscalamiento')?.touched" class="error-message">
            *Este campo es obligatorio
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="cerrarEscalamiento()">Cancelar</button>
          <button type="submit" class="submit-btn" [disabled]="escalateForm.invalid || isLoading || isLoadingTechnicians">
            <span *ngIf="!isLoading">Escalar</span>
            <span *ngIf="isLoading">Escalando...</span>
          </button>
        </div>
      </form>
      </div>
    </div>
  </div>
</div>
