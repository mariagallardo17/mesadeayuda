<div class="manage-users-container">
  <!-- Header -->
  <div class="header">
    <h1>Gesti√≥n de Usuarios</h1>
    <div class="user-icon">üë•</div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="errorMessage || successMessage">
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="icon">‚ö†Ô∏è</i>
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <i class="icon">‚úÖ</i>
      {{ successMessage }}
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main-layout" [class.with-panels]="showActionsPanel || showAddForm || showEditForm">
    <!-- Left Panel - Main Content -->
    <div class="left-panel">
      <!-- Search Bar -->
      <div class="search-container">
        <div class="search-box">
          <input
            type="text"
            placeholder="Buscar por ID o nombre del usuario... "
            [(ngModel)]="searchQuery"
            (input)="onSearchChange($event)"
            (keydown.enter)="onSearchEnter()"
            class="search-input"
            [disabled]="isLoading"
          >
          <i class="search-icon search-icon-right">üîç</i>
        </div>
      </div>

      <!-- Users Table -->
      <div class="table-container">
        <div class="loading" *ngIf="isLoading">
          <div class="spinner"></div>
          <p>Cargando usuarios...</p>
        </div>

        <table class="users-table" *ngIf="!isLoading">
          <thead>
            <tr>
              <th>ID- Nombre</th>
              <th>Correo Electr√≥nico</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId"
                class="user-row"
                [class.selected]="selectedUser?.id === user.id"
                (click)="selectUser(user)">
              <td class="user-info">
                <div class="user-avatar">
                  <span class="avatar-text">{{ user.nombre.charAt(0) }}{{ user.apellido.charAt(0) }}</span>
                </div>
                <div class="user-details">
                  <div class="user-name">{{ user.nombre }} {{ user.apellido }}</div>
                  <div class="user-id">ID: {{ user.id }}</div>
                </div>
              </td>
              <td class="user-email">{{ user.correo }}</td>
              <td>
                <span class="role-badge" [ngClass]="getRoleColor(user.rol)">
                  {{ getRoleLabel(user.rol) }}
                </span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusColor(user.activo)">
                  {{ getStatusLabel(user.activo) }}
                </span>
              </td>
              <td class="actions">
                <button class="action-trigger" (click)="showUserActions(user, $event)">
                  <i class="icon">‚ãØ</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="no-results" *ngIf="!isLoading && filteredUsers.length === 0">
          <i class="icon">üë•</i>
          <p>No se encontraron usuarios</p>
          <small *ngIf="searchQuery">Intenta con otros t√©rminos de b√∫squeda</small>
        </div>
      </div>

      <!-- Add User Button -->
      <div class="add-user-container">
        <button class="btn btn-primary add-user-btn" (click)="showAddUserForm()" [disabled]="isLoading">
          Agregar Nuevo Usuario
        </button>
      </div>
    </div>

    <!-- Right Panel - Actions and Forms -->
    <div class="right-panel">
      <!-- User Actions Panel -->
      <div class="actions-panel" *ngIf="showActionsPanel && selectedUser">
        <div class="panel-header">
          <h3>Acciones de Usuario</h3>
        </div>
        <div class="actions-list">
          <button class="action-item" (click)="showEditUserForm(selectedUser)">
            <i class="icon">‚úèÔ∏è</i>
            Editar
          </button>
          <button 
            class="action-item" 
            (click)="deleteUser(selectedUser)"
            *ngIf="!isCurrentAdmin()"
          >
            <i class="icon">üóëÔ∏è</i>
            Eliminar
          </button>
          <div 
            class="action-item disabled" 
            *ngIf="isCurrentAdmin()"
            style="opacity: 0.5; cursor: not-allowed;"
            title="No puedes eliminar tu propia cuenta"
          >
            <i class="icon">üóëÔ∏è</i>
            Eliminar (No disponible)
          </div>
          <button class="action-item" (click)="resetPassword(selectedUser)">
            <i class="icon">üîë</i>
            Resetear contrase√±a
          </button>
        </div>
      </div>

      <!-- Add User Form Panel -->
      <div class="form-panel" *ngIf="showAddForm">
        <div class="panel-header">
          <h3>Agregar Usuario</h3>
          <button class="close-btn" (click)="hideForms()">√ó</button>
        </div>

        <form [formGroup]="addUserForm" (ngSubmit)="onSubmitAddUser()" class="user-form" autocomplete="off">
          <div class="form-group">
            <label for="add-nombre">Nombre</label>
            <input
              type="text"
              id="add-nombre"
              formControlName="nombre"
              class="form-input"
              [class.error]="addNombre?.invalid && addNombre?.touched"
              placeholder="Ingrese el nombre"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
            >
            <div class="error-message" *ngIf="addNombre?.invalid && addNombre?.touched">
              <span *ngIf="addNombre?.errors?.['required']">El nombre es requerido</span>
              <span *ngIf="addNombre?.errors?.['minlength']">El nombre debe tener al menos 2 caracteres</span>
            </div>
          </div>


          <div class="form-group">
            <label for="add-correo">Correo</label>
            <input
              type="email"
              id="add-correo"
              formControlName="correo"
              class="form-input"
              [class.error]="addCorreo?.invalid && addCorreo?.touched"
              placeholder="usuario@gmail.com"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
            >
            <div class="error-message" *ngIf="addCorreo?.invalid && addCorreo?.touched">
              <span *ngIf="addCorreo?.errors?.['required']">El correo es requerido</span>
              <span *ngIf="addCorreo?.errors?.['email']">Ingrese un correo v√°lido</span>
            </div>
          </div>

          <div class="form-group">
            <label for="add-password">Contrase√±a</label>
            <input
              type="password"
              id="add-password"
              formControlName="password"
              class="form-input"
              [class.error]="addPassword?.invalid && addPassword?.touched"
              placeholder="M√≠nimo 7 caracteres (may√∫scula, n√∫mero y car√°cter especial)"
              autocomplete="new-password"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
            >
            <div class="error-message" *ngIf="addPassword?.invalid && addPassword?.touched">
              <span *ngIf="addPassword?.errors?.['required']">La contrase√±a es requerida</span>
              <span *ngIf="addPassword?.errors?.['minlength']?.message">{{ addPassword?.errors?.['minlength']?.message }}</span>
              <span *ngIf="addPassword?.errors?.['noUpperCase']?.message">{{ addPassword?.errors?.['noUpperCase']?.message }}</span>
              <span *ngIf="addPassword?.errors?.['noNumber']?.message">{{ addPassword?.errors?.['noNumber']?.message }}</span>
              <span *ngIf="addPassword?.errors?.['noSpecialChar']?.message">{{ addPassword?.errors?.['noSpecialChar']?.message }}</span>
            </div>
            <small class="form-hint">Requisitos: M√≠nimo 7 caracteres, may√∫scula, n√∫mero y car√°cter especial</small>
          </div>

          <div class="form-group">
            <label for="add-departamento">Departamento</label>
            <select
              id="add-departamento"
              formControlName="departamento"
              class="form-select"
              [class.error]="addDepartamento?.invalid && addDepartamento?.touched"
            >
              <option value="">Seleccione un departamento</option>
              <option *ngFor="let dept of departments" [value]="dept">
                {{ dept }}
              </option>
            </select>
            <div class="error-message" *ngIf="addDepartamento?.invalid && addDepartamento?.touched">
              <span *ngIf="addDepartamento?.errors?.['required']">El departamento es requerido</span>
            </div>
          </div>

          <div class="form-group">
            <label for="add-rol">Rol</label>
            <select
              id="add-rol"
              formControlName="rol"
              class="form-select"
              [class.error]="addRol?.invalid && addRol?.touched"
            >
              <option value="">Seleccione un rol</option>
              <option *ngFor="let role of getAvailableRolesForAdd()" [value]="role">
                {{ getRoleLabel(role) }}
              </option>
            </select>
            <div class="error-message" *ngIf="addRol?.invalid && addRol?.touched">
              <span *ngIf="addRol?.errors?.['required']">El rol es requerido</span>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="addUserForm.invalid || isLoading">
              <span *ngIf="isLoading" class="spinner-small"></span>
              Agregar Usuario
            </button>
          </div>
        </form>
      </div>

      <!-- Edit User Form Panel -->
      <div class="form-panel" *ngIf="showEditForm">
        <div class="panel-header">
          <h3>Editar Usuario</h3>
          <button class="close-btn" (click)="hideForms()">√ó</button>
        </div>

        <form [formGroup]="editUserForm" (ngSubmit)="onSubmitEditUser()" class="user-form">
          <div class="form-group">
            <label for="edit-nombre">Nombre</label>
            <input
              type="text"
              id="edit-nombre"
              formControlName="nombre"
              class="form-input"
              [class.error]="editNombre?.invalid && editNombre?.touched"
              placeholder="Ingrese el nombre"
            >
            <div class="error-message" *ngIf="editNombre?.invalid && editNombre?.touched">
              <span *ngIf="editNombre?.errors?.['required']">El nombre es requerido</span>
              <span *ngIf="editNombre?.errors?.['minlength']">El nombre debe tener al menos 2 caracteres</span>
            </div>
          </div>


          <div class="form-group">
            <label for="edit-correo">Correo</label>
            <input
              type="email"
              id="edit-correo"
              formControlName="correo"
              class="form-input"
              [class.error]="editCorreo?.invalid && editCorreo?.touched"
              placeholder="usuario@empresa.com"
            >
            <div class="error-message" *ngIf="editCorreo?.invalid && editCorreo?.touched">
              <span *ngIf="editCorreo?.errors?.['required']">El correo es requerido</span>
              <span *ngIf="editCorreo?.errors?.['email']">Ingrese un correo v√°lido</span>
            </div>
          </div>

          <div class="form-group">
            <label for="edit-departamento">Departamento</label>
            <select
              id="edit-departamento"
              formControlName="departamento"
              class="form-select"
              [class.error]="editDepartamento?.invalid && editDepartamento?.touched"
            >
              <option value="">Seleccione un departamento</option>
              <option *ngFor="let dept of departments" [value]="dept">
                {{ dept }}
              </option>
            </select>
            <div class="error-message" *ngIf="editDepartamento?.invalid && editDepartamento?.touched">
              <span *ngIf="editDepartamento?.errors?.['required']">El departamento es requerido</span>
            </div>
          </div>

          <div class="form-group">
            <label for="edit-rol">Rol</label>
            <select
              id="edit-rol"
              formControlName="rol"
              class="form-select"
              [class.error]="editRol?.invalid && editRol?.touched"
              [disabled]="isCurrentAdmin()"
            >
              <option value="">Seleccione un rol</option>
              <option *ngFor="let role of getAvailableRolesForEdit()" [value]="role">
                {{ getRoleLabel(role) }}
              </option>
            </select>
            <div class="error-message" *ngIf="editRol?.invalid && editRol?.touched">
              <span *ngIf="editRol?.errors?.['required']">El rol es requerido</span>
            </div>
            <div class="info-message" *ngIf="isCurrentAdmin()" style="margin-top: 5px; color: #856404; font-size: 13px;">
              ‚ö†Ô∏è No puedes cambiar tu propio rol. El administrador siempre debe mantener su rol.
            </div>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="activo"
                class="form-checkbox"
              >
              <span class="checkmark"></span>
              Usuario Activo
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="editUserForm.invalid || isLoading">
              <span *ngIf="isLoading" class="spinner-small"></span>
              Actualizar Usuario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de √©xito -->
  <div class="modal-overlay success-modal-overlay" *ngIf="showSuccessModal" (click)="closeSuccessModal()">
    <div class="modal-content success-modal-content" (click)="$event.stopPropagation()">
      <div class="success-modal-header">
        <div class="success-icon">‚úì</div>
        <h2>¬°√âxito!</h2>
      </div>
      <div class="success-modal-body">
        <p>{{ successMessage }}</p>
      </div>
      <div class="success-modal-actions">
        <button class="success-ok-btn" (click)="closeSuccessModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal de error -->
  <div class="modal-overlay error-modal-overlay" *ngIf="showErrorModal" (click)="closeErrorModal()">
    <div class="modal-content error-modal-content" (click)="$event.stopPropagation()">
      <div class="error-modal-header">
        <div class="error-icon">‚úó</div>
        <h2>Error</h2>
      </div>
      <div class="error-modal-body">
        <p>{{ errorMessage }}</p>
      </div>
      <div class="error-modal-actions">
        <button class="error-ok-btn" (click)="closeErrorModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal-overlay confirm-modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
    <div class="modal-content confirm-modal-content" (click)="$event.stopPropagation()">
      <div class="confirm-modal-header">
        <h2>{{ confirmTitle }}</h2>
        <button class="close-btn" (click)="closeConfirmModal()">√ó</button>
      </div>
      <div class="confirm-modal-body">
        <p>{{ confirmMessage }}</p>
      </div>
      <div class="confirm-modal-actions">
        <button class="cancel-btn" (click)="closeConfirmModal()">Cancelar</button>
        <button class="confirm-btn" (click)="confirmActionExecute()" [disabled]="isLoading">
          <span *ngIf="!isLoading">Aceptar</span>
          <span *ngIf="isLoading">Procesando...</span>
        </button>
      </div>
    </div>
  </div>

</div>
